<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />

    <style>
      :root {
        font-size: 1.3rem;
      }
      a {
        color: #75a3ff;
        text-underline-offset: 4px;
        text-decoration-thickness: 2px;
      }
      a:visited {
        color: #e78dc9;
      }
      a:hover {
        color: #75e8ff;
      }
      body {
        background-color: #141414;
        color: #dadada;
        font-family: Georgia, serif;
      }
      canvas,
      img,
      picture,
      svg,
      video {
        display: block;
        max-width: 100%;
      }
      figcaption {
        font-size: 92%;
        line-height: 1.3;
        letter-spacing: 0.02em;
        padding-top: 8px;
      }
      blockquote {
        font-size: 96%;
        line-height: 1.2;
      }
      main {
        max-width: 39rem;
        margin-inline: auto;
      }
      main.post > header {
        -webkit-margin-after: 4rem;
        margin-block-end: 4rem;
      }
      main.post > header > h1 {
        text-align: center;
        font-size: 2rem;
      }
      h2 {
        -webkit-margin-before: 1.5em;
        margin-block-start: 1.5em;
      }
      .post h2 {
        -webkit-margin-before: 3em;
        margin-block-start: 3em;
      }
      p {
        line-height: 1.65;
        margin-block: 1.5em;
      }
      main.post > header > p.subtitle {
        text-align: center;
        font-size: 0.9rem;
        font-style: italic;
      }
      pre {
        border: 2px solid var(--color-lightgray);
        margin-block: 2rem;
      }
      code {
        font-family: ui-monospace, SFMono-Regular, SF Mono, Menlo, Consolas,
          Liberation Mono, monospace;
        font-size: 0.9em;
        color: #ff75d1;
      }
      :is(ul, ol) > li + li {
        margin-top: 0.8em;
      }
      .post-footer {
        margin-top: 3rem;
        padding-top: 1.5rem;
        padding-bottom: 3rem;
        text-align: center;
      }
      .post-footer::before {
        content: "✶ ✶ ✶";
        color: var(--color-lightgray);
        display: block;
        text-align: center;
        margin-bottom: 1.5rem;
      }
      .post-footer > nav {
        display: flex;
        justify-content: center;
        gap: 32px;
      }
      .post-footer > nav > * {
        position: relative;
      }
      .post-footer > nav > :not(:first-child)::before {
        content: "·";
        color: #dadada;
        position: absolute;
        left: -17px;
      }
      hr {
        margin-block: 3em;
      }
      code[class*="language-"],
      pre[class*="language-"] {
        color: #f8f8f2;
        background: 0 0;
        text-align: left;
        white-space: pre;
        word-spacing: normal;
        word-break: normal;
        word-wrap: normal;
        line-height: 1.5;
        -moz-tab-size: 4;
        -o-tab-size: 4;
        tab-size: 4;
        -webkit-hyphens: none;
        hyphens: none;
      }
      pre[class*="language-"] {
        padding: 1em;
        overflow: auto;
        border-radius: 0.3em;
        display: block;
        font-size: 0.8125rem;
      }
      :not(pre) > code[class*="language-"],
      pre[class*="language-"] {
        background: #1f1f1f;
      }
      :not(pre) > code[class*="language-"] {
        padding: 0.1em;
        border-radius: 0.3em;
        white-space: normal;
      }
      .line-numbers-rows > span:before,
      .token.cdata,
      .token.comment,
      .token.doctype,
      .token.prolog {
        color: #d4d0ab;
      }
      .token.punctuation {
        color: #fefefe;
      }
      .token.constant,
      .token.property,
      .token.symbol,
      .token.tag {
        color: #ffa07a;
      }
      .token.boolean,
      .token.number {
        color: #00e0e0;
      }
      .token.attr-name,
      .token.builtin,
      .token.char,
      .token.selector,
      .token.string {
        color: #abe338;
      }
      .language-css .token.string,
      .style .token.string,
      .token.entity,
      .token.operator,
      .token.url,
      .token.variable {
        color: #00e0e0;
      }
      .token.atrule,
      .token.attr-value,
      .token.function {
        color: gold;
      }
      .token.keyword {
        color: #00e0e0;
      }
      .token.important,
      .token.regex {
        color: gold;
      }
      .token.bold,
      .token.important {
        font-weight: 700;
      }
      .token.italic {
        font-style: italic;
      }
      .token.entity {
        cursor: help;
      }
      .line-highlight {
        background: rgba(255, 217, 0, 0.1);
        border-top: 1px solid rgba(255, 217, 0, 0.55);
        border-bottom: 1px solid rgba(255, 217, 0, 0.55);
      }
      .line-numbers .line-numbers-rows {
        border-right: 1px solid #f8f8f2;
      }
      @media screen and (-ms-high-contrast: active) {
        code[class*="language-"],
        pre[class*="language-"] {
          color: windowText;
          background: window;
        }
        :not(pre) > code[class*="language-"],
        pre[class*="language-"] {
          background: window;
        }
        .token.important {
          background: highlight;
          color: window;
          font-weight: 400;
        }
        .token.atrule,
        .token.function,
        .token.keyword,
        .token.operator,
        .token.selector {
          font-weight: 700;
        }
        .token.attr-value,
        .token.comment,
        .token.doctype,
        .token.function,
        .token.keyword,
        .token.operator,
        .token.property,
        .token.string {
          color: highlight;
        }
        .token.attr-value,
        .token.url {
          font-weight: 400;
        }
      }
      .token.deleted {
        background-color: rgba(236, 154, 121, 0.2);
        color: #ffc6af;
      }
      .token.inserted {
        background-color: rgba(140, 189, 40, 0.2);
        color: #ddfd9b;
      }
      .token.prefix.deleted,
      .token.prefix.inserted,
      .token.prefix.unchanged {
        -webkit-user-select: none;
        -moz-user-select: none;
        user-select: none;
      }
    </style>

    <title>Creating TypeScript type guards with Yup</title>
  </head>

  <body>
    <main class="post">
      <header>
        <h1>Creating TypeScript type guards with Yup</h1>

        <p class="subtitle">
          Posted on
          <time class="post-date" datetime="2021-11-15">15 November 2021</time>
        </p>
      </header>

      <p>
        In TypeScript, a
        <a href="https://www.typescriptlang.org/docs/handbook/2/narrowing.html"
          >type guard</a
        >
        is a way to narrow the type of a value. TypeScript has many of these
        built in to the language. For example:
      </p>

      <pre
        class="language-ts"
        data-language="ts"
      ><code class="language-ts"><span class="token comment">// doSomething takes a single parameter that is</span><br><span class="token comment">// either a string or a number.</span><br><span class="token keyword">function</span> <span class="token function">doSomething</span><span class="token punctuation">(</span>x<span class="token operator">:</span> <span class="token builtin">string</span> <span class="token operator">|</span> <span class="token builtin">number</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">string</span> <span class="token punctuation">{</span><br>  <span class="token comment">// This is a type guard that narrows the type of</span><br>  <span class="token comment">// x to only a string.</span><br>  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> x <span class="token operator">===</span> <span class="token string">"string"</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">toUpperCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><br><br>  <span class="token comment">// Since the conditional block always returns,</span><br>  <span class="token comment">// the type of x here is narrowed to only a number.</span><br>  <span class="token keyword">return</span> x<span class="token punctuation">.</span><span class="token function">toPrecision</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>

      <p>
        You can also define your own type guard by implementing a function whose
        return type is a
        <a
          href="https://www.typescriptlang.org/docs/handbook/2/narrowing.html#using-type-predicates"
        >
          <em>type predicate</em> </a
        >. The example from the TypeScript documentation is a good one:
      </p>

      <pre
        class="language-ts"
        data-language="ts"
      ><code class="language-ts"><span class="token comment">// This is our custom type guard. It takes an argument that</span><br><span class="token comment">// is either a Fish or a Bird and reports whether that</span><br><span class="token comment">// argument can be narrowed to the Fish type.</span><br><span class="token keyword">function</span> <span class="token function">isFish</span><span class="token punctuation">(</span>pet<span class="token operator">:</span> Fish <span class="token operator">|</span> Bird<span class="token punctuation">)</span><span class="token operator">:</span> pet <span class="token keyword">is</span> Fish <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> <span class="token punctuation">(</span>pet <span class="token keyword">as</span> Fish<span class="token punctuation">)</span><span class="token punctuation">.</span>swim <span class="token operator">!==</span> <span class="token keyword">undefined</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>

      <p>
        Using a user-defined type guard works the same as any other type guard.
      </p>

      <pre
        class="language-ts"
        data-language="ts"
      ><code class="language-ts"><span class="token comment">// pet has the type Fish | Bird.</span><br><span class="token keyword">let</span> pet <span class="token operator">=</span> <span class="token function">getSmallPet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isFish</span><span class="token punctuation">(</span>pet<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token comment">// The isFish type guard narrows the type of pet to only</span><br>  <span class="token comment">// a Fish in this block.</span><br>  pet<span class="token punctuation">.</span><span class="token function">swim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>  <span class="token comment">// Same as before, the opposite narrowing also happens here.</span><br>  pet<span class="token punctuation">.</span><span class="token function">fly</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>

      <h2 id="yup-schemas">Yup schemas</h2>

      <p>
        <a href="https://github.com/jquense/yup">Yup</a> is a JavaScript library
        for creating data schemas that can be used to parse and validate values.
        You can define the shape of an object using a functional programming
        style API. Here is an example from their home page:
      </p>

      <pre
        class="language-ts"
        data-language="ts"
      ><code class="language-ts"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> yup <span class="token keyword">from</span> <span class="token string">"yup"</span><span class="token punctuation">;</span><br><br><span class="token keyword">let</span> userSchema <span class="token operator">=</span> yup<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shape</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  name<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  age<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">positive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  email<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  website<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  createdOn<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

      <p>
        This creates a schema for an object that defines a user. Yup schemas
        have methods that can, among other things, validate whether an object
        satisfies the schema. For example:
      </p>

      <pre
        class="language-ts"
        data-language="ts"
      ><code class="language-ts">userSchema<span class="token punctuation">.</span><span class="token function">isValidSync</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  name<span class="token operator">:</span> <span class="token string">"Sam Eagle"</span><span class="token punctuation">,</span><br>  age<span class="token operator">:</span> <span class="token number">47</span><span class="token punctuation">,</span><br>  email<span class="token operator">:</span> <span class="token string">"seagle@example.com"</span><span class="token punctuation">,</span><br>  createdOn<span class="token operator">:</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token string">"1974-12-10"</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// true</span><br><br>userSchema<span class="token punctuation">.</span><span class="token function">isValidSync</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  something<span class="token operator">:</span> <span class="token string">"foo"</span><span class="token punctuation">,</span><br>  notAName<span class="token operator">:</span> <span class="token string">"bar"</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// false</span></code></pre>

      <h2 id="putting-them-together">Putting them together</h2>

      <p>
        Here is our task: we have some data that has the union type
        <code>User | Admin</code>, and we want to greet them differently
        depending on the type of <code>data</code>.
      </p>

      <pre
        class="language-ts"
        data-language="ts"
      ><code class="language-ts"><span class="token keyword">const</span> data<span class="token operator">:</span> User <span class="token operator">|</span> Admin <span class="token operator">=</span> <span class="token function">getPersona</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUser</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Welcome, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>salutation<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>lastName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>

      <p>
        Our goal is to implement the type guard
        <code>isUser</code> with the following requirements:
      </p>

      <ul>
        <li>
          The <code>User</code> type is already defined (either by us or
          importing from elsewhere).
        </li>
        <li>The validation is performed by a Yup schema.</li>
        <li>
          TypeScript enforces that the Yup schema correctly validates a
          <code>User</code> type.
        </li>
      </ul>

      <p>Here we go!</p>

      <p>
        First, suppose this is the definition of a
        <code>User</code>:
      </p>

      <pre
        class="language-ts"
        data-language="ts"
      ><code class="language-ts"><span class="token keyword">interface</span> <span class="token class-name">User</span> <span class="token punctuation">{</span><br>  name<span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span><br>  age<span class="token operator">:</span> <span class="token builtin">number</span><span class="token punctuation">;</span><br>  email<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span><br>  website<span class="token operator">?</span><span class="token operator">:</span> <span class="token builtin">string</span><span class="token punctuation">;</span><br>  createdOn<span class="token operator">:</span> Date<span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>

      <p>
        We will reuse our <code>userSchema</code> from before, but this time we
        will add a type annotation to it.
      </p>

      <pre
        class="language-diff-ts"
        data-language="diff-ts"
      ><code class="language-diff-ts"><span class="token deleted-sign deleted language-ts"><span class="token prefix deleted">-</span> <span class="token keyword">const</span> userSchema <span class="token operator">=</span> yup<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shape</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br></span><span class="token inserted-sign inserted language-ts"><span class="token prefix inserted">+</span> <span class="token keyword">const</span> userSchema<span class="token operator">:</span> yup<span class="token punctuation">.</span>SchemaOf<span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token operator">=</span> yup<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shape</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br></span><span class="token unchanged language-ts"><span class="token prefix unchanged"> </span> name<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token prefix unchanged"> </span> age<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">positive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token prefix unchanged"> </span> email<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token prefix unchanged"> </span> website<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token prefix unchanged"> </span> createdOn<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br><span class="token prefix unchanged"> </span>   <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token prefix unchanged"> </span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br></span>});</code></pre>

      <p>
        By adding the type assertion for
        <code>yup.SchemaOf&lt;User&gt;</code>, we will now have assurance that
        the schema definition agrees with our type definition. To see this in
        action, try removing one of the properties.
      </p>

      <pre
        class="language-ts"
        data-language="ts"
      ><code class="language-ts"><span class="token comment">// ERROR: Property 'website' is missing in type '...'</span><br><span class="token keyword">const</span> userSchema<span class="token operator">:</span> yup<span class="token punctuation">.</span>SchemaOf<span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token operator">=</span> yup<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shape</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  name<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  age<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">positive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  email<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  createdOn<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre>

      <p>
        Be warned: the Yup schema can be <em>more</em> strict than the type it’s
        meant to check for, such as requiring more properties on the object. It
        has to be able to do this (there is no TypeScript type for “positive
        integer”). What you are guaranteed is that it will check
        <em>at least</em> for the types you pass in.
      </p>

      <p>
        Now, this is already pretty good, and calling
        <code>userSchema.isValidSync(data)</code>
        <em>will</em> narrow the type of <code>data</code>. However, it’s not
        quite perfect—the <code>else</code> branch is not narrowed!
      </p>

      <pre
        class="language-ts"
        data-language="ts"
      ><code class="language-ts"><span class="token keyword">const</span> data<span class="token operator">:</span> User <span class="token operator">|</span> Admin <span class="token operator">=</span> <span class="token function">getPersona</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUser</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>  <span class="token comment">// ERROR: Property 'salutation' does not exist on type 'User'.</span><br>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Welcome, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>salutation<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>lastName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>

      <p>
        Looking at the
        <a
          href="https://github.com/jquense/yup/blob/94cfd11b3f23e10f731efac05c5525829d10ded1/src/schema.ts?_pjax=%23js-repo-pjax-container%3Afirst-of-type%2C%20div%5Bitemtype%3D%22http%3A%2F%2Fschema.org%2FSoftwareSourceCode%22%5D%20main%3Afirst-of-type%2C%20%5Bdata-pjax-container%5D%3Afirst-of-type#L461-L464"
          >source code for <code>isValidSync</code> </a
        >, we can see why this happens. The <code>isValidSync</code> method is a
        type guard for a different type: <code>yup.Asserts&lt;User&gt;</code>,
        which is
        <a
          href="https://www.typescriptlang.org/docs/handbook/type-compatibility.html"
          >assignable</a
        >
        to our <code>User</code> type (hence why the <code>if</code> branch
        passes the type checker), but it is not our <code>User</code> type. This
        means that in the <code>else</code> branch, the type of
        <code>data</code> is still <code>User | Admin</code>.
      </p>

      <p>
        To get around this, we still need to define our own type guard.
        Thankfully, all of the hard work has been done for us by Yup.
      </p>

      <pre
        class="language-ts"
        data-language="ts"
      ><code class="language-ts"><span class="token keyword">function</span> <span class="token function">isUser</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> value <span class="token keyword">is</span> User <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> userSchema<span class="token punctuation">.</span><span class="token function">isValidSync</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>

      <p>
        That’s it! Now our original example works. Here we put it all together:
      </p>

      <pre
        class="language-ts"
        data-language="ts"
      ><code class="language-ts"><span class="token keyword">import</span> <span class="token operator">*</span> <span class="token keyword">as</span> yup <span class="token keyword">from</span> <span class="token string">"yup"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token keyword">type</span> <span class="token punctuation">{</span> User <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./types"</span><span class="token punctuation">;</span><br><span class="token keyword">import</span> <span class="token punctuation">{</span> getPersona <span class="token punctuation">}</span> <span class="token keyword">from</span> <span class="token string">"./persona"</span><span class="token punctuation">;</span><br><br><span class="token keyword">const</span> userSchema<span class="token operator">:</span> yup<span class="token punctuation">.</span>SchemaOf<span class="token operator">&lt;</span>User<span class="token operator">></span> <span class="token operator">=</span> yup<span class="token punctuation">.</span><span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">shape</span><span class="token punctuation">(</span><span class="token punctuation">{</span><br>  name<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  age<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">required</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">positive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">integer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  email<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">email</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  website<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">string</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">url</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br>  createdOn<span class="token operator">:</span> yup<span class="token punctuation">.</span><span class="token function">date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br>  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span><br><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">function</span> <span class="token function">isUser</span><span class="token punctuation">(</span>value<span class="token operator">:</span> <span class="token builtin">unknown</span><span class="token punctuation">)</span><span class="token operator">:</span> value <span class="token keyword">is</span> User <span class="token punctuation">{</span><br>  <span class="token keyword">return</span> userSchema<span class="token punctuation">.</span><span class="token function">isValidSync</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span><br><br><span class="token keyword">const</span> data<span class="token operator">:</span> User <span class="token operator">|</span> Admin <span class="token operator">=</span> <span class="token function">getPersona</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><br><span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isUser</span><span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><br>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Hello, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">!</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span><br>  <span class="token builtin">console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Welcome, </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>salutation<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string"> </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>data<span class="token punctuation">.</span>lastName<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">.</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">;</span><br><span class="token punctuation">}</span></code></pre>
    </main>

    <footer class="post-footer">
      <nav>
        <a href="/">Home</a>
        <a href="/about">About</a>
        <a href="/now">Now</a>
      </nav>
    </footer>
  </body>
</html>
